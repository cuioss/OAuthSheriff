= OAuth Sheriff DevUI Implementation
:toc: left
:toclevels: 3
:source-highlighter: highlight.js
:toc-title: Table of Contents
:sectnums:

== Overview

The Quarkus DevUI integration for the OAuth Sheriff extension provides read-only monitoring of JWT validation configuration and a convenience tool for token debugging during development. It is available only in Quarkus dev mode.

The DevUI consists of four pages:

* **Validation Status** -- Shows whether JWT validation is active and which issuers are enabled
* **JWKS Endpoints** -- Displays configured issuer URIs and JWKS loader state
* **Token Debugger** -- Accepts a JWT token and validates it against the configured issuers
* **Configuration** -- Displays the resolved runtime configuration (parser, HTTP loader, issuers)

All pages except Token Debugger are read-only viewers. Token Debugger is the only interactive page -- it validates a user-provided JWT access token.

== Architecture

=== File Structure

[source]
----
oauth-sheriff-quarkus-deployment/src/main/resources/dev-ui/
├── qwc-jwt-validation-status.js   # Validation status viewer
├── qwc-jwks-endpoints.js          # JWKS endpoint configuration viewer
├── qwc-jwt-debugger.js            # Token validation tool
└── qwc-jwt-config.js              # Configuration viewer with health indicator
----

=== Technology Stack

* **Frontend**: Lit Element web components (standard for Quarkus DevUI)
* **Communication**: JSON-RPC over WebSockets (provided by Quarkus DevUI framework)
* **Styling**: CSS custom properties using Lumo theme variables
* **Icons**: Font Awesome 6 Free (solid) via Vaadin iconset

=== Backend Integration

==== Build-Time Registration

DevUI pages are registered during build time in `OAuthSheriffProcessor.java`:

[source,java]
----
@BuildStep(onlyIf = IsDevelopment.class)
CardPageBuildItem createJwtDevUICard() {
    CardPageBuildItem cardPageBuildItem = new CardPageBuildItem();

    cardPageBuildItem.addPage(Page.webComponentPageBuilder()
        .icon("font-awesome-solid:shield-halved")
        .title("Validation Status")
        .componentLink("qwc-jwt-validation-status.js"));

    // Additional pages: JWKS Endpoints, Token Debugger, Configuration
    return cardPageBuildItem;
}
----

==== JSON-RPC Service

Backend data is provided by `OAuthSheriffDevUIRuntimeService.java`, registered as:

[source,java]
----
@BuildStep(onlyIf = IsDevelopment.class)
JsonRPCProvidersBuildItem createJwtDevUIJsonRPCService() {
    return new JsonRPCProvidersBuildItem("OAuthSheriffDevUI",
        OAuthSheriffDevUIRuntimeService.class);
}
----

The service is `@ApplicationScoped` and injects `TokenValidator`, `List<IssuerConfig>`, and `ParserConfig` from the runtime CDI container.

== JSON-RPC Methods

[cols="2,3,4"]
|===
|Method |Purpose |Response Fields

|`getValidationStatus()`
|Whether JWT validation is active
|`enabled`, `status` (ACTIVE/INACTIVE), `statusMessage`, `validatorPresent`

|`getJwksStatus()`
|Configured issuer endpoints
|`status` (CONFIGURED/NO_ISSUERS), `issuers[]` with `name`, `issuerUri`, `jwksUri`, `loaderStatus`, `lastRefresh`

|`getConfiguration()`
|Resolved runtime configuration
|`enabled`, `logLevel`, `parser{}`, `httpJwksLoader{}`, `issuers{}`

|`validateToken(token)`
|Validate a JWT access token
|`valid`, `error?`, `tokenType?`, `claims?`, `issuer?`, `details?`

|`getHealthInfo()`
|Overall extension health
|`configurationValid`, `tokenValidatorAvailable`, `overallStatus`, `message`, `healthStatus`
|===

NOTE: `validateToken` only validates access tokens (not ID or refresh tokens). ClaimValue objects are converted to simple strings for JSON-RPC serialization.

== Component Details

=== Validation Status (`qwc-jwt-validation-status.js`)

Read-only status display with auto-refresh.

* Status indicator dot (green = ACTIVE, red = INACTIVE) inline with status message
* Metrics grid: Validation Enabled, Validator Available, Overall Status
* Auto-refreshes every 30 seconds; manual refresh button available
* Error state shows retry button

=== JWKS Endpoints (`qwc-jwks-endpoints.js`)

Read-only display of configured issuer JWKS information.

* Overall status banner (green = configured, red = no issuers)
* Per-issuer cards showing: Issuer URI, JWKS URI, loader status indicator, last refresh time
* Manual refresh button in toolbar

NOTE: This page displays configuration state, not live endpoint probing. The loader status reflects the `IssuerConfig.getLoaderStatus()` value from the runtime.

=== Token Debugger (`qwc-jwt-debugger.js`)

Interactive tool for validating JWT tokens during development.

* Token input textarea for pasting JWT tokens
* "Validate Token" button -- calls `validateToken()` JSON-RPC method
* "Load Sample" button -- populates a sample HS256 JWT for experimentation
* "Clear" button -- resets input and results
* Result display: success shows token type and formatted JSON claims; failure shows error message and details

=== Configuration (`qwc-jwt-config.js`)

Read-only display of the resolved runtime configuration.

* Health indicator badge in toolbar (Healthy / Issues Detected)
* Sections: General Settings, Parser Configuration, HTTP JWKS Loader, Configured Issuers
* Optional "Configuration Issues" section when health check detects problems
* Manual refresh button in toolbar

== Security Considerations

* **Development-only**: All DevUI components are excluded from production builds (`@BuildStep(onlyIf = IsDevelopment.class)`)
* **No sensitive data storage**: Validated tokens are not logged or persisted
* **Claim serialization**: ClaimValue objects are converted to plain strings to avoid leaking internal types

== Testing

=== Unit Tests (Jest)

JavaScript unit tests in `src/test/js/` test components in isolation with mocked JSON-RPC responses. Run with:

[source,bash]
----
npm test
npm run test:coverage
----

=== E2E Tests (Playwright)

End-to-end tests in `e-2-e-playwright/` verify the full DevUI integration against a running Quarkus dev instance with Keycloak. Tests cover navigation, data rendering, interactive features, and WCAG 2.1 AA accessibility compliance.

== Usage

. Start Quarkus in development mode:
+
[source,bash]
----
./mvnw quarkus:dev
----

. Open the DevUI at `http://localhost:8080/q/dev-ui/`

. Locate the "OAuth Sheriff" extension card

. Access the four pages: Validation Status, JWKS Endpoints, Token Debugger, Configuration
