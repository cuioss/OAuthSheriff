= OAuth Sheriff DevUI Implementation
:toc: left
:toclevels: 3
:source-highlighter: highlight.js
:toc-title: Table of Contents
:sectnums:

== Overview

The Quarkus DevUI integration for the OAuth Sheriff extension provides read-only monitoring of JWT validation configuration and a convenience tool for token debugging during development. It is available only in Quarkus dev mode.

The DevUI consists of two pages:

* **Status & Config** -- Consolidated view of validation status, JWKS endpoints, issuers, and runtime configuration
* **Token Debugger** -- Accepts a JWT token and validates it against the configured issuers

Status & Config is a read-only viewer that merges data from all four JSON-RPC methods into a single page. Token Debugger is the only interactive page -- it validates a user-provided JWT access token.

== Architecture

=== File Structure

[source]
----
oauth-sheriff-quarkus-deployment/src/main/resources/dev-ui/
├── qwc-jwt-status-config.js   # Merged status and configuration viewer
└── qwc-jwt-debugger.js        # Token validation tool
----

=== Technology Stack

* **Frontend**: Lit Element web components (standard for Quarkus DevUI)
* **Communication**: JSON-RPC over WebSockets (provided by Quarkus DevUI framework)
* **Styling**: CSS custom properties using Lumo theme variables
* **Icons**: Font Awesome 6 Free (solid) via Vaadin iconset

=== Backend Integration

==== Build-Time Registration

DevUI pages are registered during build time in `OAuthSheriffProcessor.java`:

[source,java]
----
@BuildStep(onlyIf = IsDevelopment.class)
CardPageBuildItem createJwtDevUICard() {
    CardPageBuildItem cardPageBuildItem = new CardPageBuildItem();

    cardPageBuildItem.addPage(Page.webComponentPageBuilder()
        .icon("font-awesome-solid:shield-halved")
        .title("Status & Config")
        .componentLink("qwc-jwt-status-config.js"));

    cardPageBuildItem.addPage(Page.webComponentPageBuilder()
        .icon("font-awesome-solid:bug")
        .title("Token Debugger")
        .componentLink("qwc-jwt-debugger.js"));

    return cardPageBuildItem;
}
----

==== JSON-RPC Service

Backend data is provided by `OAuthSheriffDevUIRuntimeService.java`, registered as:

[source,java]
----
@BuildStep(onlyIf = IsDevelopment.class)
JsonRPCProvidersBuildItem createJwtDevUIJsonRPCService() {
    return new JsonRPCProvidersBuildItem("OAuthSheriffDevUI",
        OAuthSheriffDevUIRuntimeService.class);
}
----

The service is `@ApplicationScoped` and injects `TokenValidator`, `List<IssuerConfig>`, and `ParserConfig` from the runtime CDI container.

== JSON-RPC Methods

[cols="2,3,4"]
|===
|Method |Purpose |Response Fields

|`getValidationStatus()`
|Whether JWT validation is active
|`enabled`, `status` (ACTIVE/INACTIVE), `statusMessage`, `validatorPresent`

|`getJwksStatus()`
|Configured issuer endpoints
|`status` (CONFIGURED/NO_ISSUERS), `issuers[]` with `name`, `issuerUri`, `jwksUri`, `loaderStatus`, `lastRefresh`

|`getConfiguration()`
|Resolved runtime configuration
|`enabled`, `logLevel`, `parser{}`, `httpJwksLoader{}`, `issuers{}`

|`validateToken(token)`
|Validate a JWT access token
|`valid`, `error?`, `tokenType?`, `claims?`, `issuer?`, `details?`

|`getHealthInfo()`
|Overall extension health
|`configurationValid`, `tokenValidatorAvailable`, `overallStatus`, `message`, `healthStatus`
|===

NOTE: `validateToken` only validates access tokens (not ID or refresh tokens). ClaimValue objects are converted to simple strings for JSON-RPC serialization.

== Component Details

=== Status & Config (`qwc-jwt-status-config.js`)

Merged read-only view that calls all four JSON-RPC methods in parallel on load, with auto-refresh every 30 seconds.

**Sections (top-to-bottom):**

. **Status Overview** -- Status indicator dot (green = ACTIVE, red = INACTIVE), status message, and metrics grid (Enabled, Validator Available, Overall Status, security event counts)
. **Issuers** -- Per-issuer cards with merged data: Name, Issuer URI, JWKS URI, Loader Status, Last Refresh (from JWKS status), plus Audience, Public Key Location, Algorithm Preference (from configuration)
. **Parser Configuration** -- maxTokenSize, clockSkewSeconds, requireExpirationTime, requireNotBeforeTime, requireIssuedAtTime
. **HTTP JWKS Loader** -- connectTimeoutSeconds, readTimeoutSeconds, sizeLimit, cacheTtlSeconds, cacheSize, backgroundRefreshEnabled
. **General Settings** -- logLevel

Health indicator badge and refresh button in toolbar. Optional "Configuration Issues" section when health check detects problems.

=== Token Debugger (`qwc-jwt-debugger.js`)

Interactive tool for validating JWT tokens during development.

* Token input textarea for pasting JWT tokens
* "Validate Token" button -- calls `validateToken()` JSON-RPC method
* "Load Sample" button -- populates a sample HS256 JWT for experimentation
* "Clear" button -- resets input and results
* Result display: success shows token type and formatted JSON claims; failure shows error message and details

== Security Considerations

* **Development-only**: All DevUI components are excluded from production builds (`@BuildStep(onlyIf = IsDevelopment.class)`)
* **No sensitive data storage**: Validated tokens are not logged or persisted
* **Claim serialization**: ClaimValue objects are converted to plain strings to avoid leaking internal types

== Testing

=== Unit Tests (Jest)

JavaScript unit tests in `src/test/js/` test components in isolation with mocked JSON-RPC responses. Run with:

[source,bash]
----
npm test
npm run test:coverage
----

=== E2E Tests (Playwright)

End-to-end tests in `e-2-e-playwright/` verify the full DevUI integration against a running Quarkus dev instance with Keycloak. Tests cover navigation, data rendering, interactive features, and WCAG 2.1 AA accessibility compliance.

== Usage

. Start Quarkus in development mode:
+
[source,bash]
----
./mvnw quarkus:dev
----

. Open the DevUI at `http://localhost:8080/q/dev-ui/`

. Locate the "OAuth Sheriff" extension card

. Access the two pages: Status & Config, Token Debugger
