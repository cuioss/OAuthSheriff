= OAuth Sheriff DevUI Testing
:toc: left
:toclevels: 3
:source-highlighter: highlight.js
:toc-title: Table of Contents
:sectnums:

== Overview

The DevUI components are tested at two levels:

* **Unit tests (Jest)** -- Test individual Lit components in isolation with mocked JSON-RPC responses
* **E2E tests (Playwright)** -- Test the full DevUI integration against a running Quarkus dev instance

== Unit Tests (Jest)

Unit tests run without a Quarkus runtime. They verify component rendering, state management, and error handling using mocked backend responses.

=== Quick Start

[source,bash]
----
# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Generate coverage report
npm run test:coverage

# Run tests for CI/CD
npm run test:ci
----

=== Test Structure

----
src/test/js/
├── setup/              # Jest configuration and setup
├── mocks/              # Mock implementations (Lit, DevUI, directives)
├── components/         # Component-specific test files
└── utils/              # Test utility functions
----

=== Component Test Files

* `qwc-jwt-validation-status.test.js`
* `qwc-jwks-endpoints.test.js`
* `qwc-jwt-debugger.test.js`
* `qwc-jwt-config.test.js`

=== Mock Framework

The test setup includes mocks for:

* **Lit Library**: LitElement, html, css, and all directives
* **DevUI Services**: JSON-RPC methods with realistic responses
* **DOM Environment**: jsdom simulation for web component testing

=== Custom Test Utilities

* `toHaveRenderedContent()` -- Verify component rendering
* `toHaveShadowClass()` -- Check shadow DOM classes
* `toBeDefinedAsCustomElement()` -- Validate custom element registration
* `waitForComponentUpdate()` -- Handle async component updates
* `createTestComponent()` -- Component creation helper
* `cleanupTestComponents()` -- Test cleanup utility

=== Configuration

* `jest.config.js` -- Main Jest configuration
* `package.json` -- Dependencies and npm scripts
* `.eslintrc.js` -- Code quality enforcement

== E2E Tests (Playwright)

E2E tests verify the full DevUI integration with a running Quarkus dev instance and Keycloak.

=== Test Structure

----
e-2-e-playwright/
├── tests/
│   ├── self-devui-accessible.spec.js          # Environment gate-keeper tests
│   ├── 01-verify-validation-status.spec.js    # Validation Status page
│   ├── 02-verify-jwks-endpoints.spec.js       # JWKS Endpoints page
│   ├── 03-verify-token-debugger.spec.js       # Token Debugger page
│   ├── 04-verify-configuration.spec.js        # Configuration page
│   └── accessibility-wcag-compliance.spec.js  # WCAG 2.1 AA compliance
├── utils/
│   ├── constants.js                           # URLs, timeouts, selectors
│   └── devui-navigation.js                    # Click-based SPA navigation helpers
└── fixtures/
    └── test-fixtures.js                       # Shared test fixtures
----

=== Running E2E Tests

E2E tests require a running Quarkus dev instance and Keycloak:

[source,bash]
----
# Start Keycloak
docker compose up -d

# Start Quarkus dev mode (in integration-tests module)
./mvnw -f oauth-sheriff-quarkus-integration-tests/pom.xml quarkus:dev

# Run Playwright tests
cd e-2-e-playwright && npx playwright test
----

=== Navigation Strategy

Quarkus DevUI is a SPA (Vaadin Router + Lit web components) where extension sub-page routes are registered lazily. Direct URL navigation is fragile. Instead, tests use click-based navigation through the extension card, traversing shadow DOM to reach anchors inside `qwc-extension-link` elements.

=== Test Coverage

* **Self-tests (8)**: Environment validation (app accessible, DevUI accessible, extension visible, all 4 pages navigable, JSON-RPC runtime data)
* **Functional tests (20)**: Data rendering, interactive features per component
* **Accessibility tests (6)**: WCAG 2.1 AA compliance, keyboard navigation
